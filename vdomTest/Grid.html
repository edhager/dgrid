<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Test dgrid vdom Grid</title>
	<meta name="viewport" content="width=570">
	<style>
		@import "../../dojo/resources/dojo.css";
		@import "../css/dgrid.css";
		@import "../../dijit/themes/claro/claro.css";
		@import "../css/skins/claro.css";

		.dgrid {
			width: 2000px;
			height: 200px;
			margin: 20px 0 0 50px;
		}

		.heading {
			margin-left: 20px;
			margin-top: 20px;
			font-weight: bold;
		}
	</style>
</head>
<body class="claro">
<div class="heading">vdom grid</div>
<div id="vdomGrid"></div>
<div>
	<button id="modifyButton1">Modify</button>
</div>
<div class="heading">grid</div>
<div id="grid"></div>
<div>
	<button id="modifyButton2">Modify</button>
</div>
<script src="../../dojo/dojo.js" data-dojo-config="async: true"></script>
<script>
	var NUMBER_OF_DATA_COLUMNS = 12;
	require({
		packages: [
			{ name: 'maquette', location: '../dgrid/node_modules/maquette/dist', main: 'maquette' }
		]
	}, [
		'maquette',
		'dojo/on',
		'dgrid/Grid',
		'dgrid/vdom/Grid',
		'dgrid/_StoreMixin',
		'dgrid/vdom/_StoreMixin',
		'dgrid/vdomTest/util'
	], function (maquette, on, Grid, VdomGrid, StoreMixin, VdomStoreMixin, util) {
		var VdomRenderAllStoreMixin = VdomStoreMixin.createSubclass([], {
			refresh: function () {
				var self = this;

				// First defer to List#refresh to clear the grid's
				// previous content
				this.inherited(arguments);

				if (!this._renderedCollection) {
					return;
				}

				return this._trackError(function () {
					return self.renderQueryResults(self._renderedCollection.fetch());
				});
			},

			renderArray: function () {
				var rows = this.inherited(arguments);

				// Clear _lastCollection which is ordinarily only used for
				// store-less grids
				this._lastCollection = null;

				return rows;
			}
		});

		var RenderAllStoreMixin = StoreMixin.createSubclass([], {
			refresh: function () {
				var self = this;

				// First defer to List#refresh to clear the grid's
				// previous content
				this.inherited(arguments);

				if (!this._renderedCollection) {
					return;
				}

				return this._trackError(function () {
					return self.renderQueryResults(
							self._renderedCollection.fetch());
				});
			},

			renderArray: function () {
				var rows = this.inherited(arguments);

				// Clear _lastCollection which is ordinarily only used for
				// store-less grids
				this._lastCollection = null;

				return rows;
			}
		});

		var projector = maquette.createProjector();

		// createSyncStore clones data, so we only have to populate it once
		var data = util.makeData(100, NUMBER_OF_DATA_COLUMNS);
		var store = util.makeStore({ data: data });
		var vdomStore = util.makeStore({ data: data });

		var VdomStoreGrid = VdomGrid.createSubclass([VdomRenderAllStoreMixin]);
		var vdomGrid = new VdomStoreGrid({
			id: 'vdomGrid',
			projector: projector,
			columns: util.makeColumnDef(NUMBER_OF_DATA_COLUMNS),
			collection: vdomStore
		});
		projector.append(document.getElementById(vdomGrid.id), function () {
			return vdomGrid.create();
		});

		var StoreGrid = Grid.createSubclass([RenderAllStoreMixin]);
		var grid = new StoreGrid({
			columns: util.makeColumnDef(NUMBER_OF_DATA_COLUMNS),
			collection: store
		}, 'grid');

		on(document.getElementById('modifyButton1'), 'click', function () {
			util.modifyItem(vdomStore);
		});
		on(document.getElementById('modifyButton2'), 'click', function () {
			util.modifyItem(store);
		});
	});
</script>
</body>
</html>
